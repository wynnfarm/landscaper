{% extends "base.html" %} {% block title %}AI Assistant - Landscaper{% endblock %} {% block content %}
<div class="main-content">
  <!-- Chat Interface -->
  <section class="chat-section">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">üåø AI Landscaping Assistant</h3>
        <p class="card-subtitle">Ask me anything about our landscaping services!</p>
      </div>

      <!-- Chat Messages Container -->
      <div id="chat-messages" class="chat-messages">
        <div class="message bot-message">
          <div class="message-avatar">ü§ñ</div>
          <div class="message-content">
            <div class="message-text">
              Hello! I'm your AI landscaping assistant. I can help you with:
              <ul style="margin: 8px 0; padding-left: 20px">
                <li>Service information and pricing</li>
                <li>Landscaping advice and tips</li>
                <li>Scheduling appointments</li>
                <li>Technical questions</li>
                <li>Emergency situations</li>
              </ul>
              How can I assist you today?
            </div>
            <div class="message-meta">
              <span class="persona-badge">Customer Service</span>
              <span class="timestamp">Just now</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Input -->
      <div class="chat-input-container">
        <form id="chat-form" class="chat-form">
          <div class="input-group">
            <input
              type="text"
              id="chat-input"
              class="form-input chat-input"
              placeholder="Ask me about landscaping services..."
              autocomplete="off"
              required
            />
            <button type="submit" class="btn btn-primary chat-send-btn">
              <span class="send-icon">üì§</span>
            </button>
          </div>
        </form>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <button class="quick-action-btn" data-message="What services do you offer?">Services</button>
          <button class="quick-action-btn" data-message="How much does lawn care cost?">Pricing</button>
          <button class="quick-action-btn" data-message="I need help with my garden">Garden Help</button>
          <button class="quick-action-btn" data-message="I have an emergency">Emergency</button>
        </div>
      </div>
    </div>
  </section>

  <!-- AI Status -->
  <section class="ai-status-section">
    <div class="card">
      <h4 class="card-title">AI Assistant Status</h4>
      <div id="ai-status" class="ai-status">
        <div class="status-item">
          <span class="status-label">Status:</span>
          <span class="status-value" id="agent-status">Loading...</span>
        </div>
        <div class="status-item">
          <span class="status-label">Active Persona:</span>
          <span class="status-value" id="active-persona">Customer Service</span>
        </div>
        <div class="status-item">
          <span class="status-label">Session ID:</span>
          <span class="status-value" id="session-id">-</span>
        </div>
      </div>
    </div>
  </section>

  <!-- AI Knowledge Base -->
  <section class="knowledge-base">
    <div class="card">
      <h4 class="card-title">üß† AI Knowledge Base</h4>
      <div class="knowledge-grid">
        <div class="knowledge-item">
          <div class="knowledge-icon">üå±</div>
          <div class="knowledge-content">
            <h5>Plant Care & Selection</h5>
            <p>Comprehensive database of native plants, care requirements, and seasonal recommendations</p>
          </div>
        </div>
        <div class="knowledge-item">
          <div class="knowledge-icon">üèóÔ∏è</div>
          <div class="knowledge-content">
            <h5>Construction Techniques</h5>
            <p>Best practices for retaining walls, drainage systems, and hardscape installation</p>
          </div>
        </div>
        <div class="knowledge-item">
          <div class="knowledge-icon">üíß</div>
          <div class="knowledge-content">
            <h5>Irrigation Systems</h5>
            <p>Design principles, water efficiency, and troubleshooting for irrigation systems</p>
          </div>
        </div>
        <div class="knowledge-item">
          <div class="knowledge-icon">üßÆ</div>
          <div class="knowledge-content">
            <h5>Material Calculations</h5>
            <p>Precise calculation algorithms for materials, quantities, and project estimation</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- AI Learning & Training -->
  <section class="ai-learning">
    <div class="card">
      <h4 class="card-title">üìö AI Learning & Training</h4>
      <div class="learning-content">
        <div class="training-stats">
          <h5>Current Training Status</h5>
          <div class="stat-row">
            <span>Conversation Training:</span>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 92%"></div>
              <span class="progress-text">92%</span>
            </div>
          </div>
          <div class="stat-row">
            <span>Technical Knowledge:</span>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 88%"></div>
              <span class="progress-text">88%</span>
            </div>
          </div>
          <div class="stat-row">
            <span>Customer Service:</span>
            <div class="progress-bar">
              <div class="progress-fill" style="width: 95%"></div>
              <span class="progress-text">95%</span>
            </div>
          </div>
        </div>
        <div class="learning-updates">
          <h5>Recent Learning Updates</h5>
          <ul class="update-list">
            <li>‚úÖ Updated irrigation system troubleshooting protocols</li>
            <li>‚úÖ Added seasonal plant care recommendations</li>
            <li>‚úÖ Enhanced material cost estimation algorithms</li>
            <li>üîÑ Training on customer complaint resolution (in progress)</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- Conversation Analytics -->
  <section class="conversation-analytics">
    <div class="card">
      <h4 class="card-title">üìä Conversation Analytics</h4>
      <div class="analytics-grid">
        <div class="analytic-card">
          <h6>Daily Conversations</h6>
          <p class="metric-number">127</p>
          <small>+15% from yesterday</small>
        </div>
        <div class="analytic-card">
          <h6>Avg Response Time</h6>
          <p class="metric-number">1.2s</p>
          <small>Within target range</small>
        </div>
        <div class="analytic-card">
          <h6>Resolution Rate</h6>
          <p class="metric-number">94%</p>
          <small>+2% this week</small>
        </div>
        <div class="analytic-card">
          <h6>Customer Satisfaction</h6>
          <p class="metric-number">4.7/5</p>
          <small>Based on 89 ratings</small>
        </div>
      </div>
    </div>
  </section>
</div>

<style>
  /* Chat-specific styles */
  .chat-messages {
    max-height: 400px;
    overflow-y: auto;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 16px;
  }

  .message {
    display: flex;
    margin-bottom: 16px;
    align-items: flex-start;
  }

  .message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #2c5530;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin-right: 12px;
    flex-shrink: 0;
  }

  .user-message .message-avatar {
    background: #4a7c59;
  }

  .message-content {
    flex: 1;
    min-width: 0;
  }

  .message-text {
    background: white;
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    word-wrap: break-word;
  }

  .user-message .message-text {
    background: #e3f2fd;
  }

  .message-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
    font-size: 12px;
    color: #6c757d;
  }

  .persona-badge {
    background: #2c5530;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
  }

  .chat-input-container {
    border-top: 1px solid #e9ecef;
    padding-top: 16px;
  }

  .input-group {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .chat-input {
    flex: 1;
    margin-bottom: 0;
  }

  .chat-send-btn {
    width: auto;
    padding: 12px 16px;
    margin-bottom: 0;
    min-width: 50px;
  }

  .send-icon {
    font-size: 16px;
  }

  .quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .quick-action-btn {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    color: #495057;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .quick-action-btn:hover {
    background: #e9ecef;
    border-color: #2c5530;
    color: #2c5530;
  }

  /* Knowledge Base Styles */
  .knowledge-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .knowledge-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #17a2b8;
  }

  .knowledge-icon {
    font-size: 2rem;
    margin-right: 1rem;
  }

  .knowledge-content h5 {
    margin: 0 0 0.5rem 0;
    color: #17a2b8;
  }

  .knowledge-content p {
    margin: 0;
    font-size: 0.9rem;
    color: #6c757d;
  }

  /* AI Learning Styles */
  .learning-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 1rem;
  }

  .training-stats h5,
  .learning-updates h5 {
    margin: 0 0 1rem 0;
    color: #495057;
  }

  .stat-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .progress-bar {
    flex: 1;
    height: 20px;
    background: #e9ecef;
    border-radius: 10px;
    position: relative;
    margin: 0 1rem;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #28a745, #20c997);
    border-radius: 10px;
    transition: width 0.3s ease;
  }

  .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.75rem;
    font-weight: bold;
    color: white;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  }

  .update-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .update-list li {
    padding: 0.5rem 0;
    font-size: 0.9rem;
    border-bottom: 1px solid #e9ecef;
  }

  /* Conversation Analytics Styles */
  .analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .analytic-card {
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    text-align: center;
    border-left: 4px solid #6c757d;
  }

  .analytic-card h6 {
    margin: 0 0 0.5rem 0;
    color: #495057;
    font-size: 0.8rem;
    text-transform: uppercase;
  }

  .metric-number {
    font-size: 1.5rem;
    font-weight: bold;
    color: #2c5530;
    margin: 0.5rem 0;
  }

  .analytic-card small {
    color: #6c757d;
    font-size: 0.75rem;
  }

  .ai-status {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .status-item:last-child {
    border-bottom: none;
  }

  .status-label {
    font-weight: 500;
    color: #495057;
  }

  .status-value {
    color: #2c5530;
    font-weight: 500;
  }

  .typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #6c757d;
    font-style: italic;
  }

  .typing-dots {
    display: flex;
    gap: 2px;
  }

  .typing-dot {
    width: 4px;
    height: 4px;
    background: #6c757d;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
  }

  .typing-dot:nth-child(1) {
    animation-delay: -0.32s;
  }
  .typing-dot:nth-child(2) {
    animation-delay: -0.16s;
  }

  @keyframes typing {
    0%,
    80%,
    100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Mobile optimizations */
  @media (max-width: 480px) {
    .chat-messages {
      max-height: 300px;
      padding: 12px;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      font-size: 14px;
    }

    .message-text {
      padding: 10px 12px;
      font-size: 14px;
    }

    .quick-actions {
      gap: 6px;
    }

    .quick-action-btn {
      padding: 6px 10px;
      font-size: 12px;
    }
  }
</style>
{% endblock %} {% block extra_scripts %}
<script>
  // AI Chat functionality
  class LandscaperChat {
    constructor() {
      this.chatMessages = document.getElementById("chat-messages");
      this.chatForm = document.getElementById("chat-form");
      this.chatInput = document.getElementById("chat-input");
      this.quickActionBtns = document.querySelectorAll(".quick-action-btn");

      this.setupEventListeners();
      this.loadAIStatus();
    }

    setupEventListeners() {
      this.chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        this.sendMessage();
      });

      this.quickActionBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const message = btn.dataset.message;
          this.chatInput.value = message;
          this.sendMessage();
        });
      });
    }

    async sendMessage() {
      const message = this.chatInput.value.trim();
      if (!message) return;

      // Add user message to chat
      this.addMessage(message, "user");

      // Clear input
      this.chatInput.value = "";

      // Show typing indicator
      this.showTypingIndicator();

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            message: message,
            context: {
              page: "chat",
              timestamp: new Date().toISOString(),
            },
          }),
        });

        const data = await response.json();

        // Remove typing indicator
        this.hideTypingIndicator();

        if (data.success) {
          this.addMessage(data.response, "bot", data.persona);
        } else {
          this.addMessage("Sorry, I encountered an error. Please try again.", "bot");
        }
      } catch (error) {
        console.error("Chat error:", error);
        this.hideTypingIndicator();
        this.addMessage("Sorry, I'm having trouble connecting. Please try again.", "bot");
      }
    }

    addMessage(text, sender, persona = null) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}-message`;

      const avatar = sender === "user" ? "üë§" : "ü§ñ";
      const personaName = persona ? persona.name : "Assistant";

      messageDiv.innerHTML = `
      <div class="message-avatar">${avatar}</div>
      <div class="message-content">
        <div class="message-text">${this.formatMessage(text)}</div>
        <div class="message-meta">
          ${sender === "bot" ? `<span class="persona-badge">${personaName}</span>` : ""}
          <span class="timestamp">${new Date().toLocaleTimeString()}</span>
        </div>
      </div>
    `;

      this.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
    }

    formatMessage(text) {
      // Convert line breaks to <br> tags
      return text.replace(/\n/g, "<br>");
    }

    showTypingIndicator() {
      const typingDiv = document.createElement("div");
      typingDiv.className = "message bot-message typing-message";
      typingDiv.innerHTML = `
      <div class="message-avatar">ü§ñ</div>
      <div class="message-content">
        <div class="message-text">
          <div class="typing-indicator">
            <span>AI is typing</span>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        </div>
      </div>
    `;

      this.chatMessages.appendChild(typingDiv);
      this.scrollToBottom();
    }

    hideTypingIndicator() {
      const typingMessage = this.chatMessages.querySelector(".typing-message");
      if (typingMessage) {
        typingMessage.remove();
      }
    }

    scrollToBottom() {
      this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }

    async loadAIStatus() {
      try {
        const response = await fetch("/api/agent/status");
        const data = await response.json();

        if (data.success) {
          const status = data.status;
          document.getElementById("agent-status").textContent = status.agent_status;
          document.getElementById("active-persona").textContent = status.current_persona || "None";
          document.getElementById("session-id").textContent = status.session_id;
        }
      } catch (error) {
        console.error("Failed to load AI status:", error);
      }
    }
  }

  // Initialize chat when page loads
  document.addEventListener("DOMContentLoaded", () => {
    new LandscaperChat();
  });
</script>
{% endblock %}
