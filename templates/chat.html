{% extends "base.html" %} {% block title %}AI Assistant - Landscaper{% endblock %} {% block content %}
<div class="main-content">
  <!-- Chat Interface -->
  <section class="chat-section">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">ðŸŒ¿ AI Landscaping Assistant</h3>
        <p class="card-subtitle">Ask me anything about our landscaping services!</p>
      </div>

      <!-- Chat Messages Container -->
      <div id="chat-messages" class="chat-messages">
        <div class="message bot-message">
          <div class="message-avatar">ðŸ¤–</div>
          <div class="message-content">
            <div class="message-text">
              Hello! I'm your AI landscaping assistant. I can help you with:
              <ul style="margin: 8px 0; padding-left: 20px">
                <li>Service information and pricing</li>
                <li>Landscaping advice and tips</li>
                <li>Scheduling appointments</li>
                <li>Technical questions</li>
                <li>Emergency situations</li>
              </ul>
              How can I assist you today?
            </div>
            <div class="message-meta">
              <span class="persona-badge">Customer Service</span>
              <span class="timestamp">Just now</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Input -->
      <div class="chat-input-container">
        <form id="chat-form" class="chat-form">
          <div class="input-group">
            <input
              type="text"
              id="chat-input"
              class="form-input chat-input"
              placeholder="Ask me about landscaping services..."
              autocomplete="off"
              required
            />
            <button type="submit" class="btn btn-primary chat-send-btn">
              <span class="send-icon">ðŸ“¤</span>
            </button>
          </div>
        </form>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <button class="quick-action-btn" data-message="What services do you offer?">Services</button>
          <button class="quick-action-btn" data-message="How much does lawn care cost?">Pricing</button>
          <button class="quick-action-btn" data-message="I need help with my garden">Garden Help</button>
          <button class="quick-action-btn" data-message="I have an emergency">Emergency</button>
        </div>
      </div>
    </div>
  </section>

  <!-- AI Status -->
  <section class="ai-status-section">
    <div class="card">
      <h4 class="card-title">AI Assistant Status</h4>
      <div id="ai-status" class="ai-status">
        <div class="status-item">
          <span class="status-label">Status:</span>
          <span class="status-value" id="agent-status">Loading...</span>
        </div>
        <div class="status-item">
          <span class="status-label">Active Persona:</span>
          <span class="status-value" id="active-persona">Customer Service</span>
        </div>
        <div class="status-item">
          <span class="status-label">Session ID:</span>
          <span class="status-value" id="session-id">-</span>
        </div>
      </div>
    </div>
  </section>
</div>

<style>
  /* Chat-specific styles */
  .chat-messages {
    max-height: 400px;
    overflow-y: auto;
    padding: 16px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 16px;
  }

  .message {
    display: flex;
    margin-bottom: 16px;
    align-items: flex-start;
  }

  .message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #2c5530;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    margin-right: 12px;
    flex-shrink: 0;
  }

  .user-message .message-avatar {
    background: #4a7c59;
  }

  .message-content {
    flex: 1;
    min-width: 0;
  }

  .message-text {
    background: white;
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    word-wrap: break-word;
  }

  .user-message .message-text {
    background: #e3f2fd;
  }

  .message-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
    font-size: 12px;
    color: #6c757d;
  }

  .persona-badge {
    background: #2c5530;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 500;
  }

  .chat-input-container {
    border-top: 1px solid #e9ecef;
    padding-top: 16px;
  }

  .input-group {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
  }

  .chat-input {
    flex: 1;
    margin-bottom: 0;
  }

  .chat-send-btn {
    width: auto;
    padding: 12px 16px;
    margin-bottom: 0;
    min-width: 50px;
  }

  .send-icon {
    font-size: 16px;
  }

  .quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .quick-action-btn {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    color: #495057;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .quick-action-btn:hover {
    background: #e9ecef;
    border-color: #2c5530;
    color: #2c5530;
  }

  .ai-status {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .status-item:last-child {
    border-bottom: none;
  }

  .status-label {
    font-weight: 500;
    color: #495057;
  }

  .status-value {
    color: #2c5530;
    font-weight: 500;
  }

  .typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #6c757d;
    font-style: italic;
  }

  .typing-dots {
    display: flex;
    gap: 2px;
  }

  .typing-dot {
    width: 4px;
    height: 4px;
    background: #6c757d;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
  }

  .typing-dot:nth-child(1) {
    animation-delay: -0.32s;
  }
  .typing-dot:nth-child(2) {
    animation-delay: -0.16s;
  }

  @keyframes typing {
    0%,
    80%,
    100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Mobile optimizations */
  @media (max-width: 480px) {
    .chat-messages {
      max-height: 300px;
      padding: 12px;
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      font-size: 14px;
    }

    .message-text {
      padding: 10px 12px;
      font-size: 14px;
    }

    .quick-actions {
      gap: 6px;
    }

    .quick-action-btn {
      padding: 6px 10px;
      font-size: 12px;
    }
  }
</style>
{% endblock %} {% block extra_scripts %}
<script>
  // AI Chat functionality
  class LandscaperChat {
    constructor() {
      this.chatMessages = document.getElementById("chat-messages");
      this.chatForm = document.getElementById("chat-form");
      this.chatInput = document.getElementById("chat-input");
      this.quickActionBtns = document.querySelectorAll(".quick-action-btn");

      this.setupEventListeners();
      this.loadAIStatus();
    }

    setupEventListeners() {
      this.chatForm.addEventListener("submit", (e) => {
        e.preventDefault();
        this.sendMessage();
      });

      this.quickActionBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          const message = btn.dataset.message;
          this.chatInput.value = message;
          this.sendMessage();
        });
      });
    }

    async sendMessage() {
      const message = this.chatInput.value.trim();
      if (!message) return;

      // Add user message to chat
      this.addMessage(message, "user");

      // Clear input
      this.chatInput.value = "";

      // Show typing indicator
      this.showTypingIndicator();

      try {
        const response = await fetch("/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            message: message,
            context: {
              page: "chat",
              timestamp: new Date().toISOString(),
            },
          }),
        });

        const data = await response.json();

        // Remove typing indicator
        this.hideTypingIndicator();

        if (data.success) {
          this.addMessage(data.response, "bot", data.persona);
        } else {
          this.addMessage("Sorry, I encountered an error. Please try again.", "bot");
        }
      } catch (error) {
        console.error("Chat error:", error);
        this.hideTypingIndicator();
        this.addMessage("Sorry, I'm having trouble connecting. Please try again.", "bot");
      }
    }

    addMessage(text, sender, persona = null) {
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${sender}-message`;

      const avatar = sender === "user" ? "ðŸ‘¤" : "ðŸ¤–";
      const personaName = persona ? persona.name : "Assistant";

      messageDiv.innerHTML = `
      <div class="message-avatar">${avatar}</div>
      <div class="message-content">
        <div class="message-text">${this.formatMessage(text)}</div>
        <div class="message-meta">
          ${sender === "bot" ? `<span class="persona-badge">${personaName}</span>` : ""}
          <span class="timestamp">${new Date().toLocaleTimeString()}</span>
        </div>
      </div>
    `;

      this.chatMessages.appendChild(messageDiv);
      this.scrollToBottom();
    }

    formatMessage(text) {
      // Convert line breaks to <br> tags
      return text.replace(/\n/g, "<br>");
    }

    showTypingIndicator() {
      const typingDiv = document.createElement("div");
      typingDiv.className = "message bot-message typing-message";
      typingDiv.innerHTML = `
      <div class="message-avatar">ðŸ¤–</div>
      <div class="message-content">
        <div class="message-text">
          <div class="typing-indicator">
            <span>AI is typing</span>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
          </div>
        </div>
      </div>
    `;

      this.chatMessages.appendChild(typingDiv);
      this.scrollToBottom();
    }

    hideTypingIndicator() {
      const typingMessage = this.chatMessages.querySelector(".typing-message");
      if (typingMessage) {
        typingMessage.remove();
      }
    }

    scrollToBottom() {
      this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
    }

    async loadAIStatus() {
      try {
        const response = await fetch("/api/agent/status");
        const data = await response.json();

        if (data.success) {
          const status = data.status;
          document.getElementById("agent-status").textContent = status.agent_status;
          document.getElementById("active-persona").textContent = status.current_persona || "None";
          document.getElementById("session-id").textContent = status.session_id;
        }
      } catch (error) {
        console.error("Failed to load AI status:", error);
      }
    }
  }

  // Initialize chat when page loads
  document.addEventListener("DOMContentLoaded", () => {
    new LandscaperChat();
  });
</script>
{% endblock %}
